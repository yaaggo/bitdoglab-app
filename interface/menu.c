#include "menu.h"
#include "include/joystick.h"
#include "include/button.h"
#include "include/led.h"
#include "pico/bootrom.h"
#include <stdio.h>

#define DEBUG(VAR) printf("%s: %d\n", #VAR, VAR)

const uint8_t bitdoglab_logo	 	   [];
const uint8_t led_button_idle	 	   [];
const uint8_t led_button_selected	   [];
const uint8_t matrix_button_idle 	   [];
const uint8_t matrix_button_selected   [];
const uint8_t joystick_button_idle     [];
const uint8_t joystick_button_selected [];
const uint8_t buzzer_button_idle 	   [];
const uint8_t buzzer_button_selected   [];
const uint8_t mic_button_idle 	   	   [];
const uint8_t mic_button_selected      [];
const uint8_t display_button_idle 	   [];
const uint8_t display_button_selected  [];

menu_states state = MENU_INITIAL;
button_event button_state = BUTTON_NONE;

volatile int8_t menu_cursor = 0;
volatile int8_t menu_page = 0;

volatile int8_t led_cursor = 0;
volatile int8_t led_selected[3] = {0, 0, 0};

void menu(display *dp) {
	int8_t direction = joystick_read(JOYSTICK_X_PIN, 10, 50);
	DEBUG(direction);
	DEBUG(menu_cursor);
	DEBUG(menu_page);

	if(button_get_event() == BUTTON_JOYSTICK) {
		display_shutdown(dp);
		reset_usb_boot(0, 0);
	}

	switch(state) {
		case MENU_INITIAL:
			// trocar esse if aninhando por algo mais organizado
			if (direction > 0) {
				menu_cursor++;
				if (menu_cursor > 2) {
					menu_cursor = 0;
					menu_page = menu_page > 0 ? 0 : 1;
				}
			} else if(direction < 0) {
				menu_cursor--;
				if (menu_cursor < 0) {
					menu_cursor = 2;
					menu_page = menu_page > 0 ? 0 : 1;
				}
			}
			
			if (button_get_event() == BUTTON_A) {
				if (menu_cursor == 0 && menu_page == 0) {
					state = MENU_LED;
				}
				if (menu_cursor == 1 && menu_page == 0) {
					state = MENU_MATRIX;
				}
				if (menu_cursor == 2 && menu_page == 0) {
					state = MENU_JOYSTICK;
				}
				if (menu_cursor == 0 && menu_page == 1) {
					state = MENU_BUZZER;
				}
				if (menu_cursor == 1 && menu_page == 1) {
					state = MENU_MIC;
				}
				if (menu_cursor == 2 && menu_page == 1) {
					state = MENU_DISPLAY;
				}
				button_clear_event();
			}
			
			menu_initial_handle(menu_page, menu_cursor, dp);
		break;

		case MENU_LED:
			menu_led_handle(dp);
		break;

		case MENU_MATRIX:
			menu_matrix_handle(dp);
		break;

		case MENU_JOYSTICK:
			menu_joystick_handle(dp);
		break;

		case MENU_BUZZER:
			menu_buzzer_handle(dp);
		break;

		case MENU_MIC:
			menu_mic_handle(dp);
		break;

		case MENU_DISPLAY:
			menu_display_handle(dp);
		break;
			
	}

	if (button_get_event() == BUTTON_B) {
		state = MENU_INITIAL;
		button_clear_event();
	}
}

void menu_initial_handle(uint8_t page, uint8_t cursor, display *dp) {
    display_draw_bitmap(18, 2, bitdoglab_logo, 90, 12, 0, true, dp);
	if(page == 0) {
		display_draw_bitmap(
			14, 36,
			cursor == 0 ? led_button_selected : led_button_idle,
			24, 24, 0,
			true, dp
		);

		display_draw_bitmap(
			52, 36,
			cursor == 1 ? matrix_button_selected : matrix_button_idle,
			24, 24, 0,
			true, dp
		);
		display_draw_bitmap(
			90, 36,
			cursor == 2 ? joystick_button_selected : joystick_button_idle,
			24, 24, 0,
			true, dp
		);
	} else {
		display_draw_bitmap(
			14, 36,
			cursor == 0 ? buzzer_button_selected : buzzer_button_idle,
			24, 24, 0,
			true, dp
		);
		display_draw_bitmap(
			52, 36,
			cursor == 1 ? mic_button_selected : mic_button_idle,
			24, 24, 0,
			true, dp
		);
		display_draw_bitmap(
			90, 36,
			cursor == 2 ? display_button_selected : display_button_idle,
			24, 24, 0,
			true, dp
		);
	}
}

void menu_led_handle(display *dp) {
	int8_t direction = joystick_read(JOYSTICK_Y_PIN, 10, 50);
	char * colors[3] = {"RED", "GREEN", "BLUE"};
	uint8_t leds[3] = {LED_RED_PIN, LED_GREEN_PIN, LED_BLUE_PIN};
	uint8_t sum[3] = {8, 0, 4};

	DEBUG(direction);

	if (direction < 0) {
		led_cursor++;
		if (led_cursor > 2) {
			led_cursor = 0;
		}
	} else if(direction > 0) {
		led_cursor--;
		if (led_cursor < 0) {
			led_cursor = 2;
		}
	}

	if (button_get_event() == BUTTON_A) {
		led_selected[led_cursor] = !led_selected[led_cursor];
		led_intensity(leds[led_cursor], 50 * led_selected[led_cursor]);
		button_clear_event();
	}

	for(int i = 0; i < 3; i++) {
		if(led_selected[i]) {
			display_draw_rectangle(14, 6 + i * 18, 114, 22 + i * 18, true, true, dp);
			display_draw_string(14 + 30 + sum[i] + 1, 11 + i * 18, colors[i], false, dp);
			if (led_cursor == i) 
			display_draw_rectangle(15, 7 + 18 * led_cursor, 113, 21 + 18 * led_cursor, false, false, dp);
		} else {
			display_draw_rectangle(14, 6 + i * 18, 114, 22 + i * 18, false, true, dp);
			display_draw_string(14 + 30 + sum[i] + 1, 11 + i * 18, colors[i], true, dp);
			if (led_cursor == i)
			display_draw_rectangle(15, 7 + 18 * led_cursor, 113, 21 + 18 * led_cursor, false, true, dp);
		}
	}
}

void menu_matrix_handle(display *dp) {
	display_draw_rectangle(20, 20, 50, 50, true, true, dp);
}

void menu_joystick_handle(display *dp) {
	int8_t y = joystick_read(JOYSTICK_Y_PIN, 0, 30);
	int8_t x = joystick_read(JOYSTICK_X_PIN, 0, 30);
	display_draw_circle(64, 32, 30, false, true, dp);
	display_draw_circle(64 + x, 32 - y, 10, false, true, dp);
}

void menu_buzzer_handle(display *dp) {
	display_draw_rectangle(40, 40, 50, 50, true, true, dp);
}

// nÃ£o vai ser feito por agora
void menu_mic_handle(display *dp) {
	display_draw_char(32, 64, '?', true, dp);
}

void menu_display_handle(display *dp) {
	display_draw_rectangle(60, 50, 100, 60, true, true, dp);
}


const uint8_t bitdoglab_logo [] = {
	0x00, 0x00, 0x00, 0x00, 0xfe, 0x02, 0x22, 0x22, 0x22, 0x26, 0x3c, 0x60, 0xc0, 0x00, 0x00, 0x04, 
	0x04, 0x84, 0xfc, 0x04, 0x04, 0x00, 0x04, 0x04, 0x04, 0xff, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 
	0x00, 0xfc, 0x06, 0x06, 0x04, 0x04, 0x0c, 0x18, 0xf0, 0x00, 0xf8, 0x08, 0x04, 0x04, 0x04, 0x0c, 
	0x18, 0xf0, 0x00, 0xc0, 0x70, 0x18, 0x88, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0xfc, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xe0, 0x38, 0xf0, 0x00, 0x00, 0x00, 0xfe, 0x02, 0x22, 
	0x22, 0x22, 0x26, 0x3c, 0x60, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x06, 
	0x04, 0x04, 0x04, 0x06, 0x02, 0x03, 0x01, 0x00, 0x02, 0x02, 0x02, 0x03, 0x02, 0x02, 0x02, 0x00, 
	0x00, 0x00, 0x06, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x07, 0x04, 0x04, 0x04, 0x04, 
	0x06, 0x02, 0x03, 0x00, 0x03, 0x06, 0x04, 0x04, 0x04, 0x06, 0x03, 0x01, 0x00, 0x03, 0x06, 0x04, 
	0x04, 0x04, 0x05, 0x07, 0x00, 0x00, 0x00, 0x00, 0x03, 0x06, 0x04, 0x04, 0x04, 0x06, 0x00, 0x06, 
	0x03, 0x02, 0x02, 0x03, 0x06, 0x00, 0x00, 0x03, 0x06, 0x04, 0x04, 0x04, 0x06, 0x02, 0x03, 0x01, 
	0x00, 0x00, 0x00, 0x00
};

const uint8_t led_button_idle [] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x30, 0x08, 0x08, 0x08, 0x08, 0x30, 0xc0, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x03, 0xf2, 0x0e, 0x02, 0x02, 0xfe, 0x02, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x03, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

const uint8_t led_button_selected [] = {
	0xff, 0x01, 0x01, 0x89, 0x89, 0x99, 0x11, 0x01, 0xc1, 0xf1, 0xf9, 0xf9, 0xf9, 0xf9, 0xf1, 0xc1, 
	0x11, 0x19, 0x0d, 0x85, 0x81, 0x01, 0x01, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 
	0x03, 0xf3, 0x0f, 0x03, 0x03, 0xff, 0x03, 0x03, 0x00, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0xff, 
	0xff, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x9c, 0x83, 0x80, 0x80, 0x80, 0x9f, 0x80, 0x80, 
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xff
};

const uint8_t matrix_button_idle [] = {
	0x00, 0x00, 0xfc, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0xfc, 0x00, 0x00, 0xfc, 0x04, 0x04, 
	0x04, 0x04, 0x04, 0x04, 0x04, 0xfc, 0x00, 0x00, 0x00, 0x00, 0xe7, 0x24, 0x24, 0x24, 0x24, 0x24, 
	0x24, 0x24, 0xe7, 0x00, 0x00, 0xe7, 0x24, 0x24, 0x24, 0x24, 0x24, 0x24, 0x24, 0xe7, 0x00, 0x00, 
	0x00, 0x00, 0x3f, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x3f, 0x00, 0x00, 0x3f, 0x20, 0x20, 
	0x20, 0x20, 0x20, 0x20, 0x20, 0x3f, 0x00, 0x00
};

const uint8_t matrix_button_selected [] = {
	0xff, 0x01, 0xfd, 0xfd, 0xfd, 0xfd, 0xfd, 0xfd, 0xfd, 0xfd, 0xfd, 0x01, 0x01, 0xfd, 0x05, 0x05, 
	0x05, 0x05, 0x05, 0x05, 0x05, 0xfd, 0x01, 0xff, 0xff, 0x00, 0xe7, 0x27, 0x27, 0x27, 0x27, 0x27, 
	0x27, 0x27, 0xe7, 0x00, 0x00, 0xe7, 0xe4, 0xe4, 0xe4, 0xe4, 0xe4, 0xe4, 0xe4, 0xe7, 0x00, 0xff, 
	0xff, 0x80, 0xbf, 0xa0, 0xa0, 0xa0, 0xa0, 0xa0, 0xa0, 0xa0, 0xbf, 0x80, 0x80, 0xbf, 0xbf, 0xbf, 
	0xbf, 0xbf, 0xbf, 0xbf, 0xbf, 0xbf, 0x80, 0xff
};

const uint8_t joystick_button_idle [] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0xc4, 0x84, 0x84, 0xc4, 0x78, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x80, 0x40, 0x7f, 0x40, 0x40, 0x7f, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x0e, 0x1a, 0x32, 0x22, 0x22, 0x23, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 
	0x23, 0x22, 0x32, 0x12, 0x1a, 0x0e, 0x00, 0x00
};

const uint8_t joystick_button_selected [] = {
	0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x79, 0xc5, 0x85, 0x85, 0xc5, 0x79, 0x01, 
	0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x80, 0x40, 0x7f, 0x40, 0x40, 0x7f, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 
	0xff, 0x80, 0x8e, 0x9a, 0xb2, 0xa2, 0xa2, 0xa3, 0xa2, 0xa2, 0xa2, 0xa2, 0xa2, 0xa2, 0xa2, 0xa2, 
	0xa3, 0xa2, 0xb2, 0x92, 0x9a, 0x8e, 0x80, 0xff
};

const uint8_t buzzer_button_idle [] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x78, 0xf0, 0xc0, 
	0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x01, 0x27, 0x3f, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x1e, 0x3e, 0x3f, 0x3f, 0x3f, 0x3f, 0x1e, 0x1e, 0x0c, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

const uint8_t buzzer_button_selected [] = {
	0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xfd, 0x79, 0xf1, 0xc1, 
	0x81, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x01, 0x27, 0x3f, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 
	0xff, 0x80, 0x80, 0x80, 0x80, 0x80, 0x8c, 0x9e, 0xbe, 0xbf, 0xbf, 0xbf, 0xbf, 0x9e, 0x9e, 0x8c, 
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xff
};

const uint8_t mic_button_idle [] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xa8, 0x54, 0xac, 0x54, 0xac, 0x54, 0xa8, 
	0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0x02, 0x05, 0xfe, 0x05, 0xfe, 0x05, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x10, 0x1f, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

const uint8_t mic_button_selected [] = {
	0xff, 0x01, 0x81, 0xf1, 0x11, 0x91, 0xf1, 0x01, 0xf1, 0xa9, 0x55, 0xad, 0x55, 0xad, 0x55, 0xa9, 
	0xf1, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 0xff, 0x00, 0x01, 0x01, 0x00, 0x01, 0x01, 0x00, 
	0x01, 0x02, 0x05, 0xfe, 0x05, 0xfe, 0x05, 0x02, 0x01, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0xff, 
	0xff, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x9f, 0x90, 0x9f, 0x80, 0x80, 
	0x80, 0x80, 0x8c, 0x8f, 0x80, 0x83, 0x80, 0xff
};


const uint8_t display_button_idle [] = {
	0x00, 0x00, 0xc0, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 
	0x40, 0x40, 0x40, 0x40, 0x40, 0xc0, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 
	0x00, 0x00, 0x03, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 
	0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x00, 0x00
};

const uint8_t display_button_selected [] = {
	0xff, 0x01, 0xe1, 0x21, 0x21, 0x21, 0xa1, 0x21, 0xa1, 0xa1, 0xa1, 0x21, 0xa1, 0x21, 0xa1, 0xa1, 
	0xa1, 0x21, 0x21, 0x21, 0x21, 0xe1, 0x01, 0xff, 0xff, 0x00, 0xff, 0x00, 0xe0, 0x20, 0x21, 0xe1, 
	0x00, 0x01, 0xe4, 0x24, 0x25, 0xe4, 0x01, 0x01, 0xe0, 0xe1, 0xe0, 0xe0, 0x00, 0xff, 0x00, 0xff, 
	0xff, 0x80, 0x87, 0x84, 0x85, 0x85, 0x85, 0x85, 0x84, 0x84, 0x85, 0x85, 0x85, 0x85, 0x84, 0x84, 
	0x85, 0x85, 0x85, 0x85, 0x84, 0x87, 0x80, 0xff
};